#define _WINSOCK_DEPRECATED_NO_WARNINGS

#include <winsock2.h>
#include <iostream>
#include <string>
#include <thread>
#include <atomic>

#pragma comment(lib, "ws2_32.lib")

using std::cout;
using std::cin;
using std::endl;
using std::string;

static const char* SERVER_ADDR = "127.0.0.1";
static const unsigned short SERVER_PORT = 5555;
static const int MAX_BUF = 1024;

SOCKET g_socket = INVALID_SOCKET;
std::atomic<bool> g_connected(true);

void ServerReader()
{
    char data[MAX_BUF];

    while (g_connected)
    {
        int size = recv(g_socket, data, MAX_BUF - 1, 0);
        if (size <= 0)
        {
            cout << "\n[Система] Соединение закрыто\n";
            g_connected = false;
            break;
        }

        data[size] = '\0';
        cout << "\n" << data << endl;
    }
}

int main()
{
    setlocale(LC_ALL, "rus");

    WSADATA ws{};
    if (WSAStartup(MAKEWORD(2, 2), &ws) != 0)
    {
        cout << "Ошибка запуска Winsock\n";
        return 1;
    }

    g_socket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    if (g_socket == INVALID_SOCKET)
    {
        cout << "Ошибка сокета\n";
        return 1;
    }

    sockaddr_in server{};
    server.sin_family = AF_INET;
    server.sin_port = htons(SERVER_PORT);
    server.sin_addr.s_addr = inet_addr(SERVER_ADDR);

    cout << "Подключение...\n";
    if (connect(g_socket, (sockaddr*)&server, sizeof(server)) != 0)
    {
        cout << "Сервер недоступен\n";
        return 1;
    }

    cout << "Введите ник: ";
    string nick;
    getline(cin, nick);
    send(g_socket, nick.c_str(), (int)nick.length(), 0);

    std::thread reader(ServerReader);

    while (g_connected)
    {
        cout << "> ";
        string input;
        getline(cin, input);

        if (input == "/quit")
        {
            send(g_socket, "/quit", 5, 0);
            g_connected = false;
            break;
        }

        if (!input.empty())
            send(g_socket, input.c_str(), (int)input.length(), 0);
    }

    reader.join();
    closesocket(g_socket);
    WSACleanup();

    return 0;
}


