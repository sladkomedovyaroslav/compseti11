#include <iostream>
#include <winsock2.h>
#include <windows.h>
#pragma comment(lib, "Ws2_32.lib")

using namespace std;

#define SERVER_PORT 666

// ===== Структуры данных =====
struct StudentData {
    char surname[20];
    int marks[4];
};

struct Packet {
    int mode;               // 1 — эхо, 2 — деканат
    char text[256];
    StudentData student;
};

// ===== Глобальные ресурсы =====
int activeClients = 0;
CRITICAL_SECTION csCounter;     // защита счётчика клиентов
HANDLE consoleMutex;            // синхронизация вывода в консоль

// ===== Вывод количества клиентов =====
void showClientCount() {
    EnterCriticalSection(&csCounter);
    cout << "[Сервер] Подключено клиентов: " << activeClients << endl;
    LeaveCriticalSection(&csCounter);
}

// ===== Поток обработки клиента =====
DWORD WINAPI ClientHandler(LPVOID param) {
    SOCKET clientSocket = *(SOCKET*)param;
    delete (SOCKET*)param;

    Packet packet{};

    // Приём пакета от клиента
    if (recv(clientSocket, (char*)&packet, sizeof(packet), 0) <= 0) {
        closesocket(clientSocket);
        return 0;
    }

    WaitForSingleObject(consoleMutex, INFINITE);

    if (packet.mode == 1) {
        // ===== ЭХО-СЕРВЕР =====
        cout << "[Эхо] Получено сообщение: " << packet.text << endl;
        ReleaseMutex(consoleMutex);

        send(clientSocket, packet.text, strlen(packet.text) + 1, 0);
    }
    else if (packet.mode == 2) {
        // ===== ДЕКАНАТ =====
        StudentData s = packet.student;
        cout << "[Деканат] Студент: " << s.surname << endl;

        int minMark = 5;
        for (int i = 0; i < 4; i++)
            minMark = min(minMark, s.marks[i]);

        string reply;
        if (minMark <= 2) reply = "Задолженность";
        else if (minMark == 3) reply = "Без стипендии";
        else if (minMark == 4) reply = "Стипендия 1500";
        else reply = "Стипендия 2200";

        ReleaseMutex(consoleMutex);
        send(clientSocket, reply.c_str(), reply.size() + 1, 0);
    }

    // ===== Завершение работы клиента =====
    EnterCriticalSection(&csCounter);
    activeClients--;
    LeaveCriticalSection(&csCounter);

    showClientCount();
    closesocket(clientSocket);
    return 0;
}

// ===== Точка входа =====
int main() {
    setlocale(LC_ALL, "rus");
    SetConsoleCP(1251);
    SetConsoleOutputCP(1251);

    WSADATA wsa;
    WSAStartup(MAKEWORD(2, 2), &wsa);

    InitializeCriticalSection(&csCounter);
    consoleMutex = CreateMutex(nullptr, FALSE, nullptr);

    SOCKET serverSocket = socket(AF_INET, SOCK_STREAM, 0);

    sockaddr_in serverAddr{};
    serverAddr.sin_family = AF_INET;
    serverAddr.sin_port = htons(SERVER_PORT);
    serverAddr.sin_addr.s_addr = INADDR_ANY;

    bind(serverSocket, (sockaddr*)&serverAddr, sizeof(serverAddr));
    listen(serverSocket, SOMAXCONN);

    cout << "Сервер запущен. Ожидание клиентов...\n";

    while (true) {
        SOCKET* clientSocket = new SOCKET;
        *clientSocket = accept(serverSocket, nullptr, nullptr);

        EnterCriticalSection(&csCounter);
        activeClients++;
        LeaveCriticalSection(&csCounter);

        showClientCount();
        CreateThread(nullptr, 0, ClientHandler, clientSocket, 0, nullptr);
    }
}

