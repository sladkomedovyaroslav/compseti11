#pragma warning(disable:4996)
#include <iostream>
#include <string>

#include <WinSock2.h>
#include <WS2tcpip.h>

#pragma comment(lib, "Ws2_32.lib")

using namespace std;

const int BUFFER_LEN = 4096;

// Выполнение HTTP-запроса
bool executeHttpGet(const string& serverName, int serverPort, const string& httpQuery) {
    SOCKET connection = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    if (connection == INVALID_SOCKET) {
        cout << "Error: socket was not created\n";
        return false;
    }

    hostent* hostInfo = gethostbyname(serverName.c_str());
    if (!hostInfo) {
        cout << "Error: cannot resolve host\n";
        closesocket(connection);
        return false;
    }

    sockaddr_in serverAddr{};
    serverAddr.sin_family = AF_INET;
    serverAddr.sin_port = htons(serverPort);
    serverAddr.sin_addr.s_addr = *(u_long*)hostInfo->h_addr;

    if (connect(connection, (sockaddr*)&serverAddr, sizeof(serverAddr)) == SOCKET_ERROR) {
        cout << "Error: connection failed\n";
        closesocket(connection);
        return false;
    }

    send(connection, httpQuery.c_str(), (int)httpQuery.length(), 0);

    cout << "\n----- HTTP RESPONSE -----\n";

    char recvBuffer[BUFFER_LEN];
    int received;

    while ((received = recv(connection, recvBuffer, BUFFER_LEN - 1, 0)) > 0) {
        recvBuffer[received] = '\0';
        cout << recvBuffer;
    }

    cout << "\n----- END RESPONSE -----\n";

    closesocket(connection);
    return true;
}

// Формирование GET-запроса
string createGetRequest(const string& host) {
    return "GET / HTTP/1.1\r\n"
           "Host: " + host + "\r\n"
           "Connection: close\r\n\r\n";
}

int main() {
    WSADATA wsaData;
    if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0) {
        cout << "Winsock initialization failed\n";
        return 1;
    }

    while (true) {
        cout << "\nSelect destination:\n";
        cout << "1 - Local HTTP server\n";
        cout << "2 - json.org\n";
        cout << "3 - library.ru\n";
        cout << "0 - Exit\n";
        cout << ">> ";

        int option;
        cin >> option;

        if (option == 0) break;

        string host;
        int port = 80;

        if (option == 1) {
            host = "localhost";
            port = 8000;
        } else if (option == 2) {
            host = "json.org";
        } else if (option == 3) {
            host = "library.ru";
        } else {
            cout << "Invalid option\n";
            continue;
        }

        string request = createGetRequest(host);
        executeHttpGet(host, port, request);
    }

    WSACleanup();
    return 0;
}
