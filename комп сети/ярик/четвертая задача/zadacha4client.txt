#define _WINSOCK_DEPRECATED_NO_WARNINGS

#include <winsock2.h>
#include <iostream>
#include <string>
#include <thread>

#pragma comment(lib, "ws2_32.lib")

using namespace std;

constexpr const char* HOST = "127.0.0.1";
constexpr int CHAT_PORT = 8888;
constexpr int BUF_LEN = 1024;

SOCKET sock;
bool isActive = true;

void ListenServer()
{
    char buf[BUF_LEN];

    while (isActive)
    {
        int received = recv(sock, buf, BUF_LEN - 1, 0);

        if (received > 0)
        {
            buf[received] = '\0';
            cout << "\n" << buf << endl;
        }
        else
        {
            cout << "Соединение с сервером потеряно\n";
            isActive = false;
            break;
        }
    }
}

int main()
{
    setlocale(LC_ALL, "rus");

    WSADATA wsaData;
    if (WSAStartup(MAKEWORD(2, 2), &wsaData))
    {
        cout << "Ошибка инициализации Winsock\n";
        return 1;
    }

    sock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    if (sock == INVALID_SOCKET)
    {
        cout << "Не удалось создать сокет\n";
        return 1;
    }

    sockaddr_in server{};
    server.sin_family = AF_INET;
    server.sin_port = htons(CHAT_PORT);
    server.sin_addr.s_addr = inet_addr(HOST);

    cout << "Подключение к серверу...\n";
    if (connect(sock, (sockaddr*)&server, sizeof(server)) == SOCKET_ERROR)
    {
        cout << "Ошибка подключения\n";
        return 1;
    }

    string name;
    cout << "Ваш ник: ";
    getline(cin, name);
    send(sock, name.c_str(), name.size(), 0);

    thread listener(ListenServer);

    while (isActive)
    {
        string text;
        cout << "> ";
        getline(cin, text);

        if (text == "/quit")
        {
            send(sock, "/quit", 5, 0);
            isActive = false;
            break;
        }

        if (!text.empty())
            send(sock, text.c_str(), text.size(), 0);
    }

    listener.join();
    closesocket(sock);
    WSACleanup();

    return 0;
}
